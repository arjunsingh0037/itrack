define(["jquery"],function(a){return io={cfg:{},sock:null,wsuri:null,error:null,uniquesids:null,init:function(a,b){this.cfg=a,this.wsconnect()},wsconnect:function(){io.wsuri=this.cfg.rid,console.log(this.cfg.rid),"WebSocket"in window?this.sock=new WebSocket(io.wsuri):"MozWebSocket"in window?this.sock=new MozWebSocket(io.wsuri):(console.log("Browser does not support WebSocket!"),this.error="Browser does not support WebSocket");var b=this;this.sock.onopen=function(){console.log("Connected to "+b.cfg.rid),a.event.trigger({type:"connectionopen"}),b.userauthenticat(),b.addclient()},this.sock.binaryType="arraybuffer",this.sock.onmessage=function(c){try{if(c.data instanceof ArrayBuffer)a.event.trigger({type:"binrec",message:c.data});else{var d=JSON.parse(c.data);if("joinroom"==d.type){console.log("New user join room "+d.users);var e=null;null!=b.uniquesids&&a.each(d.clientids,function(a,c){void 0==b.uniquesids[a]&&(e=a)}),b.uniquesids=d.clientids,a.event.trigger({type:"member_added",message:d.users,newuser:e})}if("broadcastToAll"==d.type){console.log("json  : display msg");var f="";void 0!=d.userto&&(f=d.userto),a.event.trigger({type:"newmessage",message:d.m,fromUser:d.user,toUser:f})}if("userleft"==d.type){console.log("user logout");var f="";void 0!=d.userto&&(f=d.userto),null!=b.uniquesids&&delete b.uniquesids[d.user.userid],a.event.trigger({type:"user_logout",fromUser:d.user,message:"offline",toUser:f})}"leftroom"==d.type&&(console.log("member removed"),a.event.trigger({type:"member_removed",message:d.users})),"Unauthenticated"==d.type&&(console.log("Unauthenticated user"),a.event.trigger({type:"authentication_failed",message:"Authentication failed"})),"Multiple_login"==d.type&&(console.log("Multiple_login"),a.event.trigger({type:"Multiple_login"}))}}catch(b){return console.log("Error catched   : "+b),void a.event.trigger({type:"error",message:b})}},this.sock.onerror=function(c){b.error=c,console.log("Error:"+c),a.event.trigger({type:"error",message:c})},this.sock.onclose=function(c){console.log("Connection Closed"),a.event.trigger({type:"connectionclose",message:c.reason}),console.log("Connection closed (wasClean = "+c.wasClean+", code = "+c.code+", reason = '"+c.reason+"')"),setTimeout(function(){b.wsconnect()},5e3)}},userauthenticat:function(){var a={cfun:"authenticate",arg:{authuser:this.cfg.authuser,authpass:this.cfg.authpass}},b=JSON.stringify(a);this.sock.send(b)},addclient:function(){var a={cfun:"joinroom",arg:{client:this.cfg.userid,roomname:this.cfg.room,user:this.cfg.userobj}},b=JSON.stringify(a);this.sock.send(b)},send:function(a){var b={cfun:"broadcastToAll",arg:{msg:a}};if(arguments.length>1){var c=arguments[1];b.arg.touser=this.uniquesids[c]}var d=JSON.stringify(b);this.sock.send(d)},sendBinary:function(a){this.sock.send(a.buffer)},disconnect:function(){this.sock.onclose=function(){},this.sock.close(),console.log("i am closing this connection")}}});