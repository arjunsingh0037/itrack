define(["jquery","jqueryui","bundle/io/build/iolib"],function(a,b,c){a.widget("ui.chatroom",{options:{id:null,title:null,user:null,hidden:!1,offset:20,width:230,messageSent:function(a,b){this.boxManager.addMsg(a.name,b)},boxClosed:function(a){},boxManager:{init:function(a){this.elem=a},addMsg:function(b,c){var d=this,e=d.elem.uiChatboxLog,f=document.createElement("div");e.append(f);var g=!1;if(b){var h=document.createElement("b");a(h).text(b+": "),f.appendChild(h)}else g=!0;var i=document.createElement(g?"i":"span");a(i).text(c),f.appendChild(i),a(f).addClass("ui-chatbox-msg"),a(f).fadeIn(),d._scrollToBottom(),d.elem.uiChatboxTitlebar.hasClass("ui-state-focus")||d.highlightLock||(d.highlightLock=!0,d.highlightBox())},highlightBox:function(){var a=this;a.elem.uiChatboxTitlebar.addClass("ui-state-highlight"),a.highlightLock=!1,a._scrollToBottom()},toggleBox:function(){this.elem.uiChatbox.toggle("slide",{direction:"down"},1e3)},_scrollToBottom:function(){var a=this.elem.uiChatboxLog;a.scrollTop(a.get(0).scrollHeight)}}},toggleContent:function(a){this.uiChatboxContent.toggle(),this.uiChatboxContent.is(":visible")&&this.uiChatboxInputBox.focus()},widget:function(){return this.uiChatbox},_create:function(){var b=this,d=b.options,e=(d.offset,d.title||"No Title"),f=(b.uiChatbox=a("<div></div>")).appendTo(document.body).addClass("ui-widget ui-corner-top ui-chatroom").prop("id","chatrm").prop("outline",0).focusin(function(){b.uiChatboxTitlebar.removeClass("ui-state-highlight"),b.uiChatboxTitlebar.addClass("ui-state-focus")}).focusout(function(){b.uiChatboxTitlebar.removeClass("ui-state-focus")}),g=(b.uiChatboxTitlebar=a("<div></div>")).addClass("ui-widget-header ui-corner-top ui-chatroom-titlebar ui-dialog-header").click(function(a){b.uiChatboxTitlebar.removeClass("ui-state-highlight")}).appendTo(f),h=((b.uiChatboxTitle=a("<span></span>")).html(e).appendTo(g),(b.uiChatboxTitlebarMinimize=a('<a href="#"></a>')).addClass("ui-corner-all ui-chatbox-icon").prop("role","button").hover(function(){h.addClass("ui-state-hover")},function(){h.removeClass("ui-state-hover")}).focus(function(){h.addClass("ui-state-focus")}).blur(function(){h.removeClass("ui-state-focus")}).click(function(a){return d.boxManager.toggleBox(),sessionStorage.setItem("chatroom_status","hidden"),!1}).appendTo(g)),i=(a("<span></span>").addClass("ui-icon ui-icon-minusthick").text("minimize").appendTo(h),(b.uiChatboxContent=a("<div></div>")).addClass("ui-widget-content ui-chatbox-content ").appendTo(f)),j=((b.uiChatboxLog=b.element).addClass("ui-widget-content ui-chatbox-log").appendTo(i),(b.uiChatboxInput=a("<div></div>")).addClass("ui-widget-content ui-chatbox-input").click(function(a){}).appendTo(i)),k=(b.uiChatboxInputBox=a("<textarea></textarea>")).addClass("ui-widget-content ui-chatbox-input-box ui-corner-all").prop("id","ta_chrm").appendTo(j).keydown(function(d){if(d.keyCode&&d.keyCode==a.ui.keyCode.ENTER){msg=a.trim(a(this).val());var e={receiver:"chatroom",msg:msg};if(msg.length>0){c.send(e),a(this).val(""),b.options.messageSent({name:c.cfg.userobj.name},msg);var f=(new Date).getTime();if(null!=sessionStorage.getItem("chatroom")){var g=JSON.parse(sessionStorage.getItem("chatroom"));g.push({userid:c.cfg.userid,name:c.cfg.userobj.name,msg:msg,time:f}),sessionStorage.setItem("chatroom",JSON.stringify(g))}else sessionStorage.setItem("chatroom",JSON.stringify([{userid:c.cfg.userid,name:c.cfg.userobj.name,msg:msg,time:f}]))}return!1}}).focusin(function(){k.addClass("ui-chatbox-input-focus");var b=a(this).parent().prev();b.scrollTop(b.get(0).scrollHeight)}).focusout(function(){k.removeClass("ui-chatbox-input-focus")});g.find("*").add(g).disableSelection(),i.children().click(function(){b.uiChatboxInputBox.focus()}),b._setWidth(b.options.width),b._position(b.options.offset),b.options.boxManager.init(b),b.options.hidden||f.show()},_setOption:function(b,c){if(null!=c)switch(b){case"hidden":c?this.uiChatbox.hide():this.uiChatbox.show();break;case"offset":this._position(c);break;case"width":this._setWidth(c)}a.Widget.prototype._setOption.apply(this,arguments)},_setWidth:function(a){this.uiChatbox.width(a+"px"),this.uiChatboxInputBox.css("width",a-14+"px")},_position:function(a){this.uiChatbox.css("left",a)}})});