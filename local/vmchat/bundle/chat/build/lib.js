define(["jquery","bundle/io/build/iolib","build/chatboxManager","build/lang.en"],function(a,b,c,d){return{counter:0,idList:new Array,chatroombox:null,memberUpdate:function(c){var e=c.message;if("undefined"==typeof wwwroot)var f="./images/online.png";else var f=wwwroot+"local/vmchat/bundle/chat/images/online.png";if(e.length>0){var g=e.length-1;a("#user_list .inner_bt #usertab_icon").css({background:"url("+f+")no-repeat top left"})}if(a("#user_list .inner_bt #usertab_text").text(d.whos+" ("+g+")"),a("#chatroom_bt .inner_bt #chatroom_text").text(d.chatroom+" ("+g+")"),e.length>1){if(!document.getElementById("chat_div")){var h=document.createElement("div");h.id="chat_div",document.body.appendChild(h)}a("#chat_div").memberlist({id:"chat_div",user:e,offset:"37px",title:d.online,userSent:function(b){a("#chat_div").memberlist("option","boxManager").addUsr(b)}}),a("#chat_div .ui-memblist-usr").remove(),a.each(e,function(c,d){d.userid!=b.cfg.userid&&a("#chat_div").memberlist("option").userSent(d)})}else a("div#memlist").length&&a("div#memlist").remove()},messageUpdate:function(e){if(a.isPlainObject(e.message))var f=e.message.msg;else var f=e.message;var g=e.toUser,h=e.fromUser,i=b.cfg.userid,j=(new Date).getTime();if("chatroom"!=e.message.receiver||""!=g&&void 0!=g){if(void 0!=g&&""!=g){if(i==g.userid&&h.userid!=i){a.inArray(h.userid,this.idList)==-1&&(this.counter++,this.idList.push(h.userid),vmstorage[h.userid]=[],vmstorage[h.userid].push({userid:h.userid,name:h.name+" "+h.lname})),c.addBox(h.userid,{dest:"dest"+this.counter,title:"box"+this.counter,first_name:h.name,last_name:h.lname});h.userid;c.init({user:h,messageSent:function(b,c,d){a("#"+b).chatbox("option","boxManager").addMsg(c.name,d)}}),a("#"+h.userid).chatbox("option").messageSent(h.userid,h,f),a("li[aria-controls='tabcb"+h.userid+"']").addClass("ui-state-highlight");var k=h.userid}vmstorage[k].push({userid:h.userid,name:h.name,msg:f,time:j})}}else{if(i==h.userid)a("#chat_room").chatroom("option").messageSent(h,f);else if(this.chatroombox)a("#chat_room").chatroom("option").messageSent(h,f);else{if(0==a("div#chat_room").length){var l=document.createElement("div");l.id="chat_room",document.body.appendChild(l),this.chatroombox=a("#chat_room").chatroom({id:"chat_room",user:h,title:d.chatroom_header,messageSent:function(b,c){a("#chat_room").chatroom("option","boxManager").addMsg(b.name,c)}})}a("#chat_room").chatroom("option").messageSent(h,f)}if(null!=sessionStorage.getItem("chatroom")){var m=JSON.parse(sessionStorage.getItem("chatroom")),n={userid:h.userid,name:h.name,msg:f,time:j};m.push(n),sessionStorage.setItem("chatroom",JSON.stringify(m))}else sessionStorage.setItem("chatroom",JSON.stringify([{userid:h.userid,name:h.name,msg:f,time:j}]))}},statusUpdate:function(b,c,d){a("#"+b.userid).length&&(a("#"+b.userid).chatbox("option").messageSent(b.userid,b,c),a("#ta"+b.userid).prop("disabled",d))},common_chatbox_update:function(b,c){a("div#chat_room").length&&a("#chat_room").chatroom("option").messageSent(b,c)},newStatus:function(b){a.each(b.message,function(a,c){null!=b.newuser&&c.userid==b.newuser&&(this.statusUpdate(c,"Online",!1),this.common_chatbox_update(c,"Online"))})},createTab:function(b,c){var d=a("#tabs").tabs(),e=a("div#tabs ul li").length;tabId="tabcb"+b,this.addTab(d,tabId,e,c)},addTab:function(b,c,d,e){var f=a("#tab_content"),g="<li id = '"+c+"' class = 'ui-state-default ui-corner-bottom ui-tabs-active ui-state-active' aria-controls = '"+c+"'><a href = '#{href}' class = 'ui-tabs-anchor'>#{label}</a> <a href = '#' role = 'button'class = 'ui-corner-all ui-chatbox-icon'><span class = 'ui-icon ui-icon-close'>close</span></a></li>",h=e||"Tab "+d,c=c,i=a(g.replace(/#\{href\}/g,"#"+c).replace(/#\{label\}/g,h));f.val()||"Tab "+d+" content.";b.find(".ui-tabs-nav").append(i)},browserSupportsLocalStorage:function(){return"localStorage"in window&&null!=window.localStorage},displaycomChatHistory:function(){var b=this;if(sessionStorage.length>0){var c=document.createElement("div");c.id="chat_room",document.body.appendChild(c);var d=JSON.parse(sessionStorage.getItem("chatroom"));a.each(d,function(c,d){c<1&&(b.chatroombox=a("#chat_room").chatroom({id:"chat_room",user:d,title:"Common chat",messageSent:function(b,c){a("#chat_room").chatroom("option","boxManager").addMsg(b.name,c)}})),a("#chat_room").chatroom("option").messageSent(d,d.msg)})}"hidden"==sessionStorage.getItem("chatroom_status")&&a("#chatrm").hide()},displayChatHistory:function(){var b=this;if(null!=localStorage.getItem(sid)){var d=JSON.parse(localStorage.getItem(sid));a.each(d,function(d,e){b.counter++,b.idList.push(d),a.each(e,function(e,f){e<1?(c.addBox(d,{dest:"dest"+b.counter,title:"box"+b.counter,first_name:f.name}),c.init({messageSent:function(b,c,d){a("#"+b).chatbox("option","boxManager").addMsg(c.name,d)}})):a("#"+d).chatbox("option").messageSent(d,f,f.msg)}),"hidden"==localStorage.getItem(d)&&(a("#cb"+d).hide(),a("#tabcb"+d).removeClass("ui-state-active"))})}},display_error:function(b){a("<div id = 'dialog' title = 'VmChat Error:'></div>").prependTo("#stickybar"),a("#dialog").html(b),a("#dialog").dialog()},isIosDevices:function(){var a=navigator.userAgent,b=/iPad/i.test(a)||/iPhone OS 3_1_2/i.test(a)||/iPhone OS 3_2_2/i.test(a);return b}}});