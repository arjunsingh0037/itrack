define(["jquery"],function(a){function b(b,c,d){var e,f=this;this.GUTTER=14,this.MIN_WRAPPER_HEIGHT=100,this.taId=c,this.loadFailId=c+"_loadfailerr",this.textArea=a(document.getElementById(c)),this.readOnly=this.textArea.prop("readonly"),this.isLoading=!1,this.loadFailed=!1,this.retries=0,e=Math.max(parseInt(this.textArea.css("height")),this.MIN_WRAPPER_HEIGHT),this.wrapperNode=a("<div id='"+this.taId+"_wrapper' class='ui_wrapper'></div>"),this.textArea.after(this.wrapperNode),this.wrapperNode.hide(),this.wrapperNode.css({resize:"vertical",overflow:"hidden",minHeight:e,width:"100%",border:"1px solid darkgrey"}),this.textArea.data("current-ui-wrapper",this),this.uiInstance=null,this.loadUi(b,d),a(document).mousemove(function(){f.checkForResize()}),a(window).resize(function(){f.checkForResize()}),this.textArea.closest("form").submit(function(){null!==f.uiInstance&&f.uiInstance.sync()}),a(document.body).on("keydown",function(a){var b=77;a.keyCode===b&&a.ctrlKey&&a.altKey&&(null!==f.uiInstance||f.loadFailed?f.stop():f.restart())})}function c(a,c,d,e){var f;if(a){try{f=window.JSON.parse(d)}catch(g){f={}}return e&&(f.lang=e),new b(a,c,f)}return null}return b.prototype.loadUi=function(b,c){function d(b,c){require(["core/str"],function(d){var e=d.get_string(b,"qtype_coderunner"),f=d.get_string("ui_fallback","qtype_coderunner");a.when(e,f).done(function(a,b){c.html(a+"<br>"+b)})})}var e=this,f="Failed to load ",g=" UI component. If this error persists, please report it to the forum on coderunner.org.nz";return this.isLoading?(this.retries+=1,void(this.retries>20?(alert(f+b+g),this.retries=0,this.loading=0):setTimeout(function(){e.loadUi(b,c)},200))):(this.retries=0,this.params=c,this.stop(),this.uiname=b,void(""===this.uiname||"none"===this.uiname||sessionStorage.getItem("disableUis")?this.uiInstance=null:(this.isLoading=!0,require(["qtype_coderunner/ui_"+this.uiname],function(b){var f,g,h,i,j;i=e.wrapperNode.innerHeight()-e.GUTTER,j=e.wrapperNode.innerWidth(),f=new b.Constructor(e.taId,j,i,c),f.failed()?(e.loadFailed=!0,e.wrapperNode.hide(),f.destroy(),e.uiInstance=null,e.textArea.addClass("uiloadfailed"),g='<div id="'+e.loadFailId+'"class="uiloadfailed"></div>',h=a(g),h.insertBefore(e.textArea),d(f.failMessage(),h)):(e.hLast=0,e.wLast=0,e.textArea.hide(),e.wrapperNode.show(),e.wrapperNode.append(f.getElement()),e.uiInstance=f,e.loadFailed=!1,e.checkForResize()),e.isLoading=!1}))))},b.prototype.stop=function(){null!==this.uiInstance&&(this.textArea.show(),this.uiInstance.hasFocus()&&(this.textArea.focus(),this.textArea[0].selectionStart=this.textArea[0].value.length),this.uiInstance.destroy(),this.uiInstance=null,this.wrapperNode.hide()),this.loadFailed=!1,this.textArea.removeClass("uiloadfailed"),a(document.getElementById(this.loadFailId)).remove()},b.prototype.restart=function(){null===this.uiInstance&&this.loadUi(this.uiname,this.params)},b.prototype.checkForResize=function(){var b,c,d,e,f,g,h=25;this.uiInstance&&(b=this.wrapperNode.innerHeight(),d=this.wrapperNode.innerWidth(),b==this.hLast&&d==this.wLast||(f=this.wrapperNode.offset().left,g=a(window).innerWidth()-f-h,c=b-this.GUTTER,e=Math.min(g,d),this.uiInstance.resize(e,c),this.hLast=this.wrapperNode.innerHeight(),this.wLast=this.wrapperNode.innerWidth()))},{newUiWrapper:c,InterfaceWrapper:b}});