define(["jquery","core/log","core/ajax","core/templates","core/str"],function(a,b,c,d,e){"use strict";function f(c){b.debug("block_todo/control: initializing controls of the todo block instance "+c);var d=a('[data-region="block_todo-instance-'+c+'"]').first();if(!d.length)return void b.error("block_todo/control: wrapping region not found!");var e=new g(d);e.main()}function g(a){var b=this;b.region=a}return g.prototype.main=function(){var a=this;a.addTextForm=a.region.find('[data-control="addform"]').first(),a.addTextInput=a.addTextForm.find("input").first(),a.addTextButton=a.addTextForm.find("button").first(),a.itemsList=a.region.find("ul").first(),a.initAddFeatures(),a.initEditFeatures()},g.prototype.initAddFeatures=function(){var a=this;a.addTextForm.on("submit",function(b){b.preventDefault(),a.addNewTodo()}),a.addTextButton.on("click",function(){a.addTextForm.submit()})},g.prototype.initEditFeatures=function(){var b=this;b.itemsList.on("click","[data-item]",function(c){c.preventDefault(),c.stopPropagation();var d=a(c.currentTarget).attr("data-item");b.toggleItem(d)}),b.itemsList.on("click",'[data-control="delete"]',function(c){c.preventDefault(),c.stopPropagation();var d=a(c.currentTarget).closest("[data-item]").attr("data-item");b.deleteItem(d)})},g.prototype.addNewTodo=function(){var f=this,g=a.trim(f.addTextInput.val());return g?(f.addTextInput.prop("disabled",!0),c.call([{methodname:"block_todo_add_item",args:{todotext:g}}])[0].fail(function(c){return b.error("block_todo/control: unable to add the item"),b.debug(c),f.addTextButton.addClass("btn-danger"),f.addTextButton.html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>'),a.Deferred().reject()}).then(function(a){return d.render("block_todo/item",a).fail(function(a){b.error("block_todo/control: unable to render the new item:"+a)})}).then(function(b){return f.itemsList.prepend(b),f.addTextInput.val(""),f.addTextInput.prop("disabled",!1),f.addTextInput.focus(),a.Deferred().resolve()})):e.get_string("placeholdermore","block_todo").then(function(b){return f.addTextInput.prop("placeholder",b),a.Deferred().resolve()})},g.prototype.toggleItem=function(e){var f=this;return e?c.call([{methodname:"block_todo_toggle_item",args:{id:e}}])[0].fail(function(c){return b.error("block_todo/control: unable to toggle the item"),b.debug(c),a.Deferred().reject()}).then(function(a){return d.render("block_todo/item",a).fail(function(a){b.error("block_todo/control: unable to render the new item:"+a)})}).then(function(b){return f.itemsList.find('[data-item="'+e+'"]').replaceWith(b),a.Deferred().resolve()}):a.Deferred().resolve()},g.prototype.deleteItem=function(d){var e=this;return d?c.call([{methodname:"block_todo_delete_item",args:{id:d}}])[0].fail(function(c){return b.error("block_todo/control: unable to delete the item"),b.debug(c),a.Deferred().reject()}).then(function(b){return e.itemsList.find('[data-item="'+b+'"]').remove(),a.Deferred().resolve()}):a.Deferred().resolve()},{init:f}});